"use strict";function noop(){}function eigen(e){return e}function isFunction(e){return"function"==typeof e}function wrapSource(e){var r=wrapBuffer(e),n=0,t={pos:function(){return n},skip:function(e){return n+=e,t},ui8arr:function(e){var r=0,n=[];for(n.length=e;r<e;++r)n[r]=t.ui8();return n},ui8:function(){var e=ui8(r,n);return n+=1,e},ui16LE:function(){var e=ui16LE(r,n);return n+=2,e},ui32LE:function(){var e=ui32LE(r,n);return n+=4,e},ui32BE:function(){var e=ui32BE(r,n);return n+=4,e},f64LE:function(){var e=f64LE(r,n);return n+=8,e}};return t}function parseCore(e,r,n){var t,o=e[0]?parseShape(wrapSource(e[0]),n):{},e=e[1]?parseDBF(wrapSource(e[1]),n):{},n=buildFeatures(o.shapes||[],e.records||[],r);return n.length?(t={type:"FeatureCollection",features:n}).bbox=o.bBox:t=null,t}function buildFeatures(e,r,n){for(var t,o=[],i=o.length=Math.max(e.length,r.length),a=0;a<i;++a)t=e[a]||{},o[a]={type:"Feature",geometry:{type:t.geoJSON_type||null,coordinates:t.coordinates?n(t.coordinates):[]},properties:r[a]||null};return o}function createCoordinatesRounder(e){var r=Number("1E"+e);function n(e){return Math.round(e*r)/r}return function e(r){return r.map(r[0].length?e:n)}}function buildParseArgs(r){return r=r||{},["shp","dbf"].map(function(e){return function(n){r.substr?(e="."+e,sendRequest(r+(r.substr(-e.length).toLowerCase()===e?"":e),function(e,r){n(e,r)})):n(null,r[e]||null)}})}function parse(e,t,o){var i;return when(buildParseArgs(e),function(e,r){o=isFunction(t)&&t||isFunction(o)&&o||noop,t=!isFunction(t)&&t||{};var n=[];e.forEach(function(e){e&&n.push(e)}),i=parseCore(r,0<=t.precision?createCoordinatesRounder(t.precision):eigen,n),o(i,n.length?n:null)}),i}function when(e,r){var t=[],o=[],i=1;function a(){0===--i&&r(t,o)}e.forEach(function(e,n){++i,e(function(e,r){t[n]=e,o[n]=r,a()})}),a()}function parseShape(e,r){var n,t,o,i,a=[];try{n=new Date,o=parseShapeHeader(e)}catch(e){return void r.push("shp: header parsing error: "+e.message+" / "+e.description)}9994!==o.fileCode&&r.push("shp: file code: "+o.fileCode+" / expected: 9994"),1e3!==o.version&&r.push("shp: file version: "+o.version+" / expected: 1000");try{for(;e.pos()<o.fileLength&&(i=parseShapeRecord(e,o.type,r));)a.push(i);e.pos()!==o.fileLength&&r.push("shp: file length: "+o.fileLength+" / actual: "+e.pos()),t=new Date}catch(e){r.push("shp: records parsing error: "+e.message+" / "+e.description)}return{bBox:o.bBox_XY,type:o.shapeType,shapes:a,errors:r,time:t-n}}function readPointShape(e,r){r.coordinates=readPointArray(e,1)[0]}function readPolyLineShape(e,r){var n,t=readBBox(e),o=readInteger(e),i=readInteger(e),a=readIntegerArray(e,o),s=readPointArray(e,i),u=[];for(u.length=o,n=0;n<o;++n)u[n]=s.slice(a[n],a[n+1]||i);r.bBox=t,r.coordinates=u}function readMultiPointShape(e,r){r.bBox=readBBox(e),r.coordinates=readPointArray(e,readInteger(e))}function readPointMShape(e,r){r.coordinates=readPointArray(e,1)[0],r.coordinates.push(readDoubleArray(e,1)[0])}function readMultiPointMShape(e,r){var n=readBBox(e),t=readInteger(e),o=readPointArray(e,t),i=readPair(e),e=readDoubleArray(e,t);r.bBox=n,r.mBox=i,r.coordinates=merge_XYM(o,e,t)}function readPolyLineMShape(e,r){var n,t,o,i=readBBox(e),a=readInteger(e),s=readInteger(e),u=readIntegerArray(e,a),c=readPointArray(e,s),p=readPair(e),l=readDoubleArray(e,s),d=[];for(d.length=a,n=0;n<a;++n)t=u[n],o=u[n+1]||s,d[n]=merge_XYM(c.slice(t,o),l.slice(t,o),o-t);r.bBox=i,r.mBox=p,r.coordinates=d}function readPointZShape(e,r){r.coordinates=readPointArray(e,1)[0],r.push(readDoubleArray(e,1)[0],readDoubleArray(e,1)[0])}function readMultiPointZShape(e,r){var n=readBBox(e),t=readInteger(e),o=readPointArray(e,t),i=readPair(e),a=readDoubleArray(e,t),s=readPair(e),e=readDoubleArray(e,t);r.bBox=n,r.zBox=i,r.mBox=s,r.coordinates=merge_XYZM(o,a,e,t)}function readPolyLineZShape(e,r){var n,t,o,i=readBBox(e),a=readInteger(e),s=readInteger(e),u=readIntegerArray(e,a),c=readPointArray(e,s),p=readPair(e),l=readDoubleArray(e,s),d=readPair(e),f=readDoubleArray(e,s),h=[];for(h.length=a,n=0;n<a;++n)t=u[n],o=u[n+1]||s,h[n]=merge_XYZM(c.slice(t,o),l.slice(t,o),f.slice(t,o),o-t);r.bBox=i,r.zBox=p,r.mBox=d,r.coordinates=h}function readMultiPatchShape(e,r){var n,t,o,i=readBBox(e),a=readInteger(e),s=readInteger(e),u=readIntegerArray(e,a),c=readIntegerArray(e,a),p=readPointArray(e,s),l=readPair(e),d=readDoubleArray(e,s),e=readPair(e),f=[];for(f.length=a,n=0;n<a;++n)t=u[n],o=u[n+1]||s,f[n]=merge_XYZM(p.slice(t,o),d.slice(t,o),mValues.slice(t,o),o-t);r.bBox=i,r.zBox=l,r.mBox=e,r.types=c,r.coordinates=f}exports.parse=parse;var SHP_TYPES={0:"Null",1:"Point",3:"PolyLine",5:"Polygon",8:"MultiPoint",11:"PointZ",13:"PolyLineZ",15:"PolygonZ",18:"MultiPointZ",21:"PointM",23:"PolyLineM",25:"PolygonM",28:"MultiPointM",31:"MultiPatch"},SHP_RECORD_PARSERS={0:noop,1:readPointShape,3:readPolyLineShape,5:readPolyLineShape,8:readMultiPointShape,11:readPointZShape,13:readPolyLineZShape,15:readPolyLineZShape,18:readMultiPointZShape,21:readPointMShape,23:readPolyLineMShape,25:readPolyLineMShape,28:readMultiPointMShape,31:readMultiPatchShape},SHP_TYPE_TO_GEOJSON_TYPE_MAP={Null:"Null",Point:"Point",PolyLine:"MultiLineString",Polygon:"Polygon",MultiPoint:"MultiPoint",PointZ:"Point",PolyLineZ:"MultiLineString",PolygonZ:"Polygon",MultiPointZ:"MultiPoint",PointM:"Point",PolyLineM:"MultiLineString",PolygonM:"Polygon",MultiPointM:"MultiPoint",MultiPatch:"MultiPatch"};function parseShapeHeader(e){var r={};return r.fileCode=e.ui32BE(),e.skip(20),r.fileLength=e.ui32BE()<<1,r.version=e.ui32LE(),r.type_number=e.ui32LE(),r.type=SHP_TYPES[r.type_number],r.bBox_XY=readBBox(e),r.bBox_ZM=readPointArray(e,2),r}function readInteger(e){return e.ui32LE()}function readIntegerArray(e,r){var n,t=[];for(t.length=r,n=0;n<r;++n)t[n]=readInteger(e);return t}function readDoubleArray(e,r){var n,t=[];for(t.length=r,n=0;n<r;++n)t[n]=e.f64LE();return t}function readBBox(e){return readDoubleArray(e,4)}function readPair(e){return[e.f64LE(),e.f64LE()]}function readPointArray(e,r){var n,t=[];for(t.length=r,n=0;n<r;++n)t[n]=readPair(e);return t}function merge_XYM(e,r,n){var t,o=[];for(o.length=n,t=0;t<n;++t)o[t]=[e[t][0],e[t][1],r[t]];return o}function merge_XYZM(e,r,n,t){var o,i=[];for(i.length=t,o=0;o<t;++o)i[o]=[e[o][0],e[o][1],r[o],n[o]];return i}function parseShapeRecord(e,r,n){var t={number:e.ui32BE()},o=e.ui32BE()<<1,i=e.pos(),a=e.ui32LE();return t.type_number=a,t.type=SHP_TYPES[a],t.geoJSON_type=SHP_TYPE_TO_GEOJSON_TYPE_MAP[t.type],t.type?(t.type!==r&&n.push("shp: shape #"+t.number+" type: "+t.type+" / expected: "+r),SHP_RECORD_PARSERS[a](e,t),(i=e.pos()-i)!=o&&n.push("shp: shape #"+t.number+" length: "+o+" / actual: "+i)):(n.push("shp: shape #"+t.number+" type: "+a+" / unknown"),t=null),t}function parseDBF(e,r){var n,t,o,i,a;try{n=new Date,i=prepareDataBaseFileRecordParseData(o=parseDataBaseFileHeader(e,r),r),a=parseDataBaseFileRecords(e,o.numberOfRecords,o.recordLength,i,r),t=new Date}catch(e){r.push("dbf: parsing error: "+e.message+" / "+e.description)}return{records:a,errors:r,time:t-n}}function parseDataBaseFileHeader(e,r){var n,t,o={versionNumber:e.ui8(),lastUpdate:new Date(1900+e.ui8(),e.ui8()-1,e.ui8()),numberOfRecords:e.ui32LE(),headerLength:e.ui16LE(),recordLength:e.ui16LE(),fields:[]};for(e.skip(20),n=(o.headerLength-e.pos()-1)/32;0<n;--n)o.fields.push(parseFieldDescriptor(e));return 13!==(t=e.ui8())&&r.push("dbf: header terminator: "+t+" / expected: 13"),o}var _fromCharCode=String.fromCharCode;function getAsciiString(e,r){return _fromCharCode.apply(null,e.ui8arr(r))}function parseFieldDescriptor(e){var r={name:getAsciiString(e,11).replace(/\0*$/gi,""),type:_fromCharCode(e.ui8()),length:e.skip(4).ui8(),count:e.ui8()};return e.skip(14),r}var DBF_FIELD_PARSERS={C:function(e,r){e=getAsciiString(e,r);try{e=decodeURIComponent(escape(e))}catch(e){}return e.trim()},N:function(e,r){e=getAsciiString(e,r);return parseFloat(e)},D:function(e,r){e=getAsciiString(e,r);return new Date(e.substring(0,4),e.substring(4,6)-1,e.substring(6,8))}};function DBF_FIELD_PARSER_DEFAULT(e,r){return e.skip(r),null}function prepareDataBaseFileRecordParseData(e,r){for(var n,t,o=[],i=0,a=e.fields.length,s=0,i=0;i<a;++i)(n={name:(t=e.fields[i]).name,parser:DBF_FIELD_PARSERS[t.type],length:t.length}).parser||(n.parser=DBF_FIELD_PARSER_DEFAULT,r.push("dbf: field "+t.name+" type: "+t.type+" / unknown")),s+=t.length,o.push(n);return s+1!==e.recordLength&&r.push("dbf: record length: "+e.recordLength+" / actual: "+(s+1)),o}function parseDataBaseFileRecords(e,r,n,t,o){for(var i,a,s,u,c=t.length,p=[],l=0;l<r;++l){for(s={},a=e.pos(),e.skip(1),i=0;i<c;++i)s[(u=t[i]).name]=u.parser(e,u.length);(a=e.pos()-a)!==n&&o.push("dbf: record #"+(l+1)+" length: "+n+" / actual: "+a),p.push(s)}return p}function wrapBuffer(e){return e}function ui8(e,r){return e[r]}function ui16LE(e,r){return e.readUInt16LE(r)}function ui32LE(e,r){return e.readUInt32LE(r)}function ui32BE(e,r){return e.readUInt32BE(r)}function f64LE(e,r){return e.readDoubleLE(r)}var fs=require("fs");function sendRequest(e,r){fs.readFile(e,r)}var path=require("path");function normalizeJsName(e){return e.trim().replace("-","_").replace(" ","_")}function processFile(n,t,o){var i=path.basename(n,path.extname(n));t.info("%s: started",i),parse(n,{precision:t.precision},function(e,r){t.info("%s: finished",i),r&&r.forEach(function(e){t.error("  "+e)}),e?(r=JSON.stringify(t.processData(e),null,t.isDebug&&4),t.isJSON||(r=t.processFileContent(r,normalizeJsName(i))),fs.writeFile(path.resolve(t.output||path.dirname(n),t.processFileName(i+(t.isJSON?".json":".js"))),r,function(e){e&&t.error("  "+e.message),o()})):o()})}function collectFiles(e,t){var o=path.resolve(e||"");function i(e){return".shp"===path.extname(e).toLowerCase()}function a(e){return path.basename(e,".shp")}fs.stat(o,function(e,r){e?t(e,[]):r.isFile()?t(null,i(o)?[path.resolve(path.dirname(o),a(o))]:[]):r.isDirectory()?fs.readdir(o,function(e,r){var n=[];r.forEach(function(e){i(e)&&n.push(path.resolve(o,a(e)))}),t(null,n)}):t(null,[])})}function importFile(e){var r;try{r=require(path.resolve(String(e)))}catch(e){}return r}function pickFunctionOption(e){return isFunction(e)&&e||e&&importFile(String(e))||null}function processFileContentByDefault(e,r){return r+" = "+e+";"}function prepareSettings(e,r){return(r=Object.assign({},r)).settings&&(r=Object.assign(importFile(r.settings)||{},r)),Object.assign(r,{input:e?String(e):null,output:r.output?String(r.output):null,precision:0<=r.precision?Math.round(r.precision):4,processData:pickFunctionOption(r.processData)||eigen,processFileName:pickFunctionOption(r.processFileName)||eigen,processFileContent:pickFunctionOption(r.processFileContent)||processFileContentByDefault,info:r.isQuiet?noop:console.info.bind(console),error:r.isQuiet?noop:console.error.bind(console)})}function processFiles(e,r,n){var t=prepareSettings(e,r&&r.trim?importFile(r):r);t.info("Started"),collectFiles(t.input,function(e,r){e&&t.error(e.message),t.info(r.map(function(e){return"  "+path.basename(e)}).join("\n")),when(r.map(function(r){return function(e){processFile(r,t,e)}}),function(){t.info("Finished"),(isFunction(n)?n:noop)()})})}exports.processFiles=processFiles;var COMMAND_LINE_ARG_KEYS=[{key:"--output",name:"output",arg:!0,desc:"Destination directory"},{key:"--process-data",name:"processData",arg:!0,desc:"Process parsed data"},{key:"--process-file-name",name:"processFileName",arg:!0,desc:"Process output file name"},{key:"--process-file-content",name:"processFileContent",arg:!0,desc:"Process output file content"},{key:"--precision",name:"precision",arg:!0,desc:"Precision of shape coordinates"},{key:"--json",name:"isJSON",desc:"Generate as a .json file"},{key:"--debug",name:"isDebug",desc:"Generate non minified file"},{key:"--quiet",name:"isQuiet",desc:"Suppress console output"},{key:"--settings",name:"settings",arg:!0,desc:"Path to settings file"},{key:"--help",name:"isHelp",desc:"Print help"}];function parseCommandLineArgs(){var n=process.argv.slice(2),t={isEmpty:!n.length},o={};return n.forEach(function(e,r){o[e]=n[r+1]||!0}),COMMAND_LINE_ARG_KEYS.forEach(function(e){var r=o[e.key];r&&(t[e.name]=!e.arg||r)}),(t.isHelp||t.isEmpty)&&(t=null,printCommandLineHelp()),t}function printCommandLineHelp(){var e,n=["node ",path.basename(process.argv[1])," Source "],t=[],o=Math.max.apply(null,COMMAND_LINE_ARG_KEYS.map(function(e){return e.key.length}))+2;COMMAND_LINE_ARG_KEYS.forEach(function(e){var r=e.key;n.push(r," "),e.arg&&n.push("<",r.slice(2),">"," "),t.push(["  ",r,Array(o-r.length).join(" "),e.desc].join(""))}),e=["Generates dxVectorMap-compatible files from shapefiles.","\n",n.join("")].concat(t).join("\n"),console.log(e)}function runFromConsole(){var e=parseCommandLineArgs();e&&processFiles(process.argv[2]||"",e)}require.main===module&&runFromConsole();